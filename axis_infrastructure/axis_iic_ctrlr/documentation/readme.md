# axis_iic_ctrlr

Компонент для работы с шиной I2C, поддерживает AXI-Stream интерфейс для записи и для чтения. Поддерживается выбор различных устройств, выбор адреса устройства осуществляется через шину AXI-Stream. Поддержка различных разрядностей шины AXI-Stream. 

При работе с компонентом применяется особый формат посылок, первое слово должно всегда быть количеством байт, которое необходимо считать/записать. Операция, которую необходимо выполнять, также выбирается на основе передаваемого адреса устройства. 

Асинхронный режим не поддерживается. Компонент работает по домену `CLK`

![axis_iic_ctrlr_struct][axis_iic_ctrlr_struct_link]

[axis_iic_ctrlr_struct_link]:https://github.com/MasterPlayer/xilinx-sv/blob/master/axis_infrastructure/axis_iic_ctrlr/documentation/axis_iic_ctrlr_struct.png

## generic-параметры
Параметр | Тип | Диапазон значений | описание
---------|-----|-------------------|---------
CLK_PERIOD | integer | >5000000 | Значение частоты сигнала тактирования CLK
CLK_I2C_PERIOD | integer | 100000, 400000 | Значение частоты сигнала тактирования шины I2C
N_BYTES | integer | 8..N | Разрядность шин AXI-STREAM
DEPTH | integer | 16..N | Глубина очереди данных

## 1. Порты 

### 1.1 AXI-Stream 

Компонент содержит Master и Slave AXI-Stream порты для операций чтения/записи

#### 1.1.1. Slave AXI-Stream 

необходим при выполнении каждой транзакции для того чтобы передать компоненту первым словом количество байт, которые необходимо считать/записать на устройство. При выполнении операции чтения допустим размер пакета, равный одному слову. 
При выполнении операции записи первым словом идет количество байт, который необходимо передать, последующие слова - данные, которые будут переданы на устройство

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
S_AXIS_TDATA | in | N_BYTES*8 | сигнал данных
S_AXIS_TKEEP | in | N_BYTES | сигнал валидных байт в слове
S_AXIS_TDEST | in | 8 | адрес устройства I2C, выполняемая операция
S_AXIS_TVALID | in | 1 | сигнал валидности данных
S_AXIS_TREADY | out | 1 | сигнал готовности компонента к приему данных
S_AXIS_TLAST | in | 1 | сигнал конца пакета

#### 1.1.2. Master AXI-Stream 

Формат шины `M_AXIS_*` поддерживает передачу только данных, которые читаются с устройства I2C, никаких дополнительных слов компонент не вставляет 

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
M_AXIS_TDATA | out | N_BYTES*8 | сигнал данных 
M_AXIS_TKEEP | out | N_BYTES | сигнал валидных байт в слове
M_AXIS_TDEST | out | 8 | адрес устройства I2C
M_AXIS_TVALID | out | 1 | сигнал валидности данных
M_AXIS_TREADY | in | 1 | сигнал готовности внешнего компонента к приему данных
M_AXIS_TLAST | out | 1 | сигнал конца пакета

### 1.2 I2C

Стандартная шина I2C. Внутри компонента отсутствуют двунаправленные буферы ввода-вывода, их надо ставить отдельно. 

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
scl_i | in | 1 | сигнал тактирования от двунаправленного буфера
sda_i | in | 1 | сигнал данных от двунаправленного буфера
scl_t | out | 1 | выходной сигнал тактирования к двунаправленному буферу
sda_t | out | 1 | выходной сигнал данных к двунаправленному буферу

## 2. Принцип работы компонента

- Шина Slave AXI-Stream `S_AXIS_*` задействуется при выполнении любой операции всегда. При операции записи через шину передаются только данные. При операции чтения применяется следующий формат данных, представленный на рисунке ниже:

![axis_iic_ctrlr_data_format][axis_iic_ctrlr_data_format_link]

[axis_iic_ctrlr_data_format_link]:https://github.com/MasterPlayer/xilinx-sv/blob/master/axis_infrastructure/axis_iic_ctrlr/documentation/axis_iic_ctrlr_data_format.png

- Количество слов для одной операции чтения не должен превышать максимальный размер выходной FIFO. При превышении размера очереди, количество считываемых данных для одной операции будет равно максимальному количеству слов выходной очереди. Это делается для того, чтобы избежать возможной потери данных при чтении, если выходная очередь (fifo_out_sync_xpm) не может принять данные, так как переполнена. 
- Со стороны операции записи разрешается записывать сколько угодно данных на устройство. Размер посылок разрешен быть от 1 байта. 
- TKEEP поддерживается Для операций чтения и операций записи
- TDEST обозначает адрес устройства I2C, куда передавать данные. Помимо этого, в TDEST младшем бите указывается выполняемая операция(чтение или запись на устройство). Компонент анализирует младший бит TDEST для того чтобы узнать какую операцию выполнять
- Внутри компонента данные сериализуются через счетчик бит со старшего по младший бит. Старший бит является первым битом в слове, которое будет передаваться на устройство.
- Передача данных со стороны AXI-Stream не должна содержать разрывов в данных. Пакет должен укладываться в компонент целиком, без разрывов по валидам внутри одного пакета. В противном случае, работоспособность не гарантируется, так как при активной транзакции, при передаче данных из входной очереди на выход не анализируется флаг empty у этой очереди. При невысокой скорости потока, компонент не сможет сообщить устройству об ожидании, и транзакция закончится неудачно. 
- Сигнал SCL_T получается из счетчиков, которые находятся внутри компонента. - Внутренние счетчики задают поведение тактового сигнала SCL, который изменяется по событию Assertion/Deassertion некоторой группы сигналов. 
**Возможно, в дальнейшем необходимо будет переписать данный механизм другим способом, более простым и гибким**
- Работа компонента подчинена работе внутреннего конечного автомата.
- При операции чтения компонент вставляет полученный на входе TDEST для того чтобы можно было адресовать поток данных другому приемному устройству средствами, предусмотренными AXI-Stream протоколом. 
- Компонент не содержит двунаправленного буфера (INOUT). Двунаправленный буфер подключается снаружи.

### 3. Конечный автомат

Компонент выполняет операции чтения и записи. Все последовательности действий при нормальной работе подчиняются работе конечного автомата. Процесс инициализации отсутствует, после сброса компонент переходит в состояние ожидания данных на входе `S_AXIS_`.

3.1 Состояния конечного автомата

3.1.1 Операция записи

Операцию записи может положить отсутствие ответа(ACK) от ведомого устройства. В таком случае транзакция выполняется бесконечно. 


Текущее состояние | Действия | Следующее состояние | Условие перехода
------------------|----------|---------------------|-----------------
IDLE_ST | Ожидание данных на входе `S_AXIS` | START_TRANSMISSION | Переход в следующее состояние 
START_TRANSMISSION | Промежуточное состояние, ничего не происходит | TX_ADDR_ST | безусловный переход
TX_ADDR_ST | передаем адрес(`S_AXIS_TDEST`) до тех пор, пока счетчик бит не будет равен нулю | WAIT_ACK_ST
WAIT_ACK_ST | Ожидание сигнала ACK от внешнего устрйоства | WRITE_ST | получен сигнал ACK от устройства
WRITE_ST | Передача данных на устройство | WAIT_WR_ACK_ST | счетчик бит равен нулю
WAIT_WR_ACK_ST | Ожидание ответа ACK от устройства | STOP_TRANSMISSION | если нет валидных битов в слове, и если получен сигнал конца пакета
WAIT_WR_ACK_ST | Ожидание ответа ACK от устройства | WRITE_ST | если есть данные, которые не были переданы. 
STOP_TRANSMISSION | окончание транзакции, промежуточное состояние | IDLE_ST | Безусловный переход

3.1.2 Операция чтения

Текущее состояние | Действия | Следующее состояние | Условие перехода
------------------|----------|---------------------|-----------------
IDLE_ST | Ожидание данных на входе `S_AXIS_` | START TRANSMISSION | входная очередь не пуста, выходная очередь не пуста, младший бит TDEST = 0
START_TRANSMISSION | Промежуточное состоинче, ничего не происходит | TX_ADDR_ST | безусловный переход 
TX_ADDR_ST | передача адреса на шину I2C | WAIT_ACK_ST | счетчик бит равен нулю
WAIT_ACK_ST | Ожидание ответа(ACK) от устройства | READ_ST | отклик от устройства получен
READ_ST | Чтение данных с шины I2C | WAIT_RD_ACK_ST | счетчик бит равен нулю
waIT_RD_ACK_ST | Промежуточное состояние, выбор что делать дальше: завершение транзакции или продолжение чтения данных с шины | READ_ST | Если количество читаемых байт не равно нулю, то переход к чтению нового байта от устройства
WAIT_RD_ACK_ST | Промежуточное состояние, выбор что делать дальше: завершение транзакции или продолжение чтения данных с шины | STOP_TRANSMISSION | счетчик байт равен нулю
STOP_TRANSMISSION | Промежуточное состояние, окончание транзакции | IDLE_ST | Безусловный переход

## 4. Необходимые внешние компоненты 

Название компонент | Описание
-------------------|---------
[fifo_in_sync_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_in_sync_xpm/fifo_in_sync_xpm.vhd) | Входная очередь данных для шины `S_AXIS_`
[fifo_out_sync_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_out_sync_xpm/fifo_out_sync_xpm.vhd) | Выходная очередь данных для шины `M_AXIS_`

## 5. TO DO :: 
1. Изменить способ формирования сигналов `i2c_clk_assertion`, `scl_t`. Текущие недостатки данного способа кроются в крайней нестабильности
2. Исключить зависание транзакции записи по пункту 3.1.1, вероятно ввести таймаут ожидания. 
3. Вероятно, на группе `S_AXIS_` сигнал TDEST надо заменить на TID, так как инфраструктура AXI не сможет коммутировать несколько источников в один выходной порт. 
4. Рассмотреть возможность полной поддержки сигнала `M_AXIS_TREADY`. Режим скорее всего можно сделать так:
- при невозможности записать данные в выходную очередь, формировать ранний TLAST и заканчивать транзакций. 
- При невозможности записать данные, запоминать текущий байт записанного и потом, при возможности, организовать трансфер вновь. 
Оба варианта позволят избежать большой очереди

## 6. Лог изменений

**1. 05.08.2021 : v1.0 - первая версия**
Добавлен компонент и документация к нему с рисунками и диаграммами

